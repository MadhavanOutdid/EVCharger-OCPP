<!DOCTYPE html>
    <html>

    <head>
        <title>Start Transaction</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    </head>
    <style>
      table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
      }
     
      td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
      }
     
      tr:nth-child(even) {
        background-color: #dddddd;
      }
      </style>

    <body>

        <h2>ENTER CHARGER ID</h2><input type="text" id="chargerID">
        <button id="chargerSUBMIT">GET INFO</button></br></br>

        <div id="actionBtn" style="width: 100%;">
          <button id="startTransactionBtn">Start Transaction</button>
          <button id="stopTransactionBtn">Stop Transaction</button>
          <h3>CHARGER STATUS: <p id="currentstatus"></p></h3>
        </div></br>

        <table id="ChargerValue">
          <tr>
            <th>Voltage</th>
            <th>Current</th>
            <th>Power</th>
            <th>Energy</th>
            <th>Frequency</th>
            <th>Temperature</th>
          </tr>
          <tr>
            <td id="voltage"></td>
            <td id="current"></td>
            <td id="power"></td>
            <td id="energy"></td>
            <td id="frequency"></td>
            <td id="temperature"></td>
          </tr>
        </table>

    </body>

    </html>

<script>

var chargerURL = '';
var isChargerAvailabe = '';

$(document).ready(function () {
    $('#actionBtn').hide();
    $('#ChargerValue').hide();
});

$('#chargerSUBMIT').click(function () {
  fetchData(function(result) {
    if (result) {
      $('#actionBtn').show();
      $('#ChargerValue').show();
    } else {
      $('#actionBtn').hide();
      $('#ChargerValue').hide();
    }
  });
  isChargerAvailabe = true;
  CallInterval(isChargerAvailabe);
});

function CallInterval(isChargerAvailabe){
  if(isChargerAvailabe == true){
    var interval = 1000; // 1 seconds
    setInterval(fetchData, interval);
  }else{
    console.log('setInterval is not working !');
  }
}

function fetchData(callback) {
    var chargerID = $('#chargerID').val();

    $.ajax({
        type: 'GET',
        data: { chargerID: chargerID },
        url: '/checkDeviceID',
        success: function (response) {
            $('#currentstatus').empty();
            $('#voltage, #current, #power, #energy, #frequency, #temperature').empty();

            if (response == 'DeviceNotAvailable') {
                console.log('ChargerNotAvailable');
                $('#actionBtn').hide();
                $('#ChargerValue').hide();
            } else {
                chargerURL = chargerID;

                var status = response.statusData[0].status;
                const timestamp = formatTimestamp(response.statusData[0].timestamp);

                $('#currentstatus').append(status + ' - ' + timestamp);

                var voltage = response.valueData['Voltage'];
                var current = response.valueData['Current.Import'];
                var power = response.valueData['Power.Active.Import'];
                var energy = response.valueData['Energy.Active.Import.Register'];
                var frequency = response.valueData['Frequency'];
                var powerfactor = response.valueData['Power.Factor'];

                $('#voltage').append(voltage);
                $('#current').append(current);
                $('#power').append(power);
                $('#energy').append(energy);
                $('#frequency').append(frequency);
                $('#temperature').append(powerfactor);

                if (callback) {
                  callback(true);
                }
            }
       
        },
        error: function (response) {
            console.log(response);
           
            if (callback) {
                callback(false);
            }
        }
    });
}

function formatTimestamp(originalTimestamp) {

    const date = new Date(originalTimestamp);

    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    const formattedDate = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;

    return formattedDate;
}

const startTransactionBtn = document.getElementById('startTransactionBtn');
startTransactionBtn.addEventListener('click', function () {
    $.ajax({
        type: 'GET',
        url: '/start',
        data: { id: chargerURL },
        success: function (data, textStatus, jqXHR) {
            if (jqXHR.status === 200) {
                console.log("OK - ChargerStarted");
            }
        },
        error: function(error){
          console.log("ChargerNotStarted - " + error);
        }
    });
});

const stopTransactionBtn = document.getElementById('stopTransactionBtn');
stopTransactionBtn.addEventListener('click', function () {
    $.ajax({
        type: 'GET',
        url: '/stop',
        data: { id: chargerURL },
        success: function (data, textStatus, jqXHR) {
            if (jqXHR.status === 200) {
                console.log("OK - ChargerStopped");
            }
        },
        error: function(error){
          console.log("ChargerNotStopped - " +error);
        }
    });
});

</script>